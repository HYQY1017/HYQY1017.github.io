
<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å°ä½• - æ–‡ä»¶å‹ç¼©</title>
<style>
:root{--bg-color:#ffffff;--text-color:#333333;--primary-color:#000000;--secondary-color:#f8f8f8;--border-color:#e0e0e0;--hover-color:#f0f0f0;--danger-color:#d32f2f;--button-text:#ffffff;}
*{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;}
body{background-color:var(--bg-color);color:var(--text-color);min-height:100vh;}
.container{max-width:1200px;margin:0 auto;padding:20px;}
header{display:flex;justify-content:space-between;align-items:center;padding:20px 0;border-bottom:1px solid var(--border-color);margin-bottom:30px;}
.title{font-size:24px;font-weight:600;color:var(--primary-color);}
.controls{display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap;}
button{padding:8px 16px;border:none;border-radius:4px;background-color:var(--primary-color);color:var(--button-text);cursor:pointer;font-size:14px;transition:opacity 0.2s;}
button:hover{opacity:0.9;}
button.danger{background-color:var(--danger-color);}
button.secondary{background-color:var(--secondary-color);color:var(--text-color);border:1px solid var(--border-color);}
#file-input{display:none;}
.file-manager{border:1px solid var(--border-color);border-radius:6px;min-height:400px;padding:15px;background-color:var(--secondary-color);}
.file-list{list-style:none;margin-top:10px;}
.file-item{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border-radius:4px;margin-bottom:5px;background-color:var(--bg-color);transition:background-color 0.2s;}
.file-item:hover{background-color:var(--hover-color);}
.file-item.folder{font-weight:500;cursor:pointer;}
.file-item .name{display:flex;align-items:center;gap:8px;flex:1;}
.file-item .depth-indicator{width:15px;height:1px;background-color:transparent;display:inline-block;}
.file-item .actions{display:flex;gap:8px;}
.file-item .actions button{padding:4px 8px;font-size:12px;}
.empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;height:300px;color:var(--text-color);opacity:0.7;}
.hidden{display:none;}
.path-bar{margin-bottom:15px;padding:8px 10px;background-color:var(--bg-color);border-radius:4px;border:1px solid var(--border-color);}
.path-item{display:inline-block;margin-right:5px;cursor:pointer;}
.path-item:hover{text-decoration:underline;}
.path-separator{margin:0 5px;}
</style>
</head>
<body>
<div class="container">
<header>
<div class="title">å°ä½• - æ–‡ä»¶å‹ç¼©</div>
<button id="back-btn">ğŸ  è¿”å›ä¸»é¡µ</button>
</header>
<div class="controls">
<button type="button" id="import-btn">å¯¼å…¥æ–‡ä»¶</button>
<input type="file" id="file-input" multiple>
<button type="button" id="new-folder">æ–°å»ºæ–‡ä»¶å¤¹</button>
<button type="button" id="export-zip" class="secondary">å¯¼å‡ºZIP</button>
</div>
<div class="file-manager">
<div class="path-bar" id="path-bar"></div>
<div class="empty-state" id="empty-state">
<p>æš‚æ— æ–‡ä»¶ï¼Œè¯·å¯¼å…¥æ–‡ä»¶æˆ–æ–°å»ºæ–‡ä»¶å¤¹</p>
</div>
<ul class="file-list" id="file-list"></ul>
</div>
</div>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<script>
const fileListEl = document.getElementById('file-list');
const emptyState = document.getElementById('empty-state');
const fileInput = document.getElementById('file-input');
const importBtn = document.getElementById('import-btn');
const newFolderBtn = document.getElementById('new-folder');
const exportZipBtn = document.getElementById('export-zip');
const pathBar = document.getElementById('path-bar');
const backBtn = document.getElementById('back-btn');

const ROOT_NODE = {
    id: 'root',
    name: 'æ ¹ç›®å½•',
    type: 'folder',
    children: [],
    parent: null,
    depth: 0
};
let currentNode = ROOT_NODE;
let currentPath = [ROOT_NODE];
let hasFiles = false;

function updatePathBar() {
    let pathHtml = '';
    currentPath.forEach((node, index) => {
        pathHtml += `<span class="path-item" data-id="${node.id}">${node.name}</span>`;
        if (index < currentPath.length - 1) {
            pathHtml += `<span class="path-separator">/</span>`;
        }
    });
    pathBar.innerHTML = pathHtml;
    
    document.querySelectorAll('.path-item').forEach(item => {
        item.addEventListener('click', function() {
            const targetId = this.dataset.id;
            navigateToNode(findNodeById(ROOT_NODE, targetId));
        });
    });
}

function findNodeById(root, id) {
    if (root.id === id) return root;
    let found = null;
    for (const child of root.children) {
        if (child.id === id) {
            found = child;
            break;
        }
        if (child.type === 'folder') {
            found = findNodeById(child, id);
            if (found) break;
        }
    }
    return found;
}

function navigateToNode(node) {
    currentNode = node;
    currentPath = [];
    let tempNode = node;
    while (tempNode) {
        currentPath.unshift(tempNode);
        tempNode = tempNode.parent;
    }
    updateFileList();
    updatePathBar();
}

function generateUniqueId() {
    return 'id_' + Date.now() + '_' + Math.floor(Math.random() * 1000);
}

function updateFileList() {
    hasFiles = ROOT_NODE.children.length > 0;
    
    if (currentNode.children.length === 0) {
        emptyState.classList.remove('hidden');
        fileListEl.classList.add('hidden');
    } else {
        emptyState.classList.add('hidden');
        fileListEl.classList.remove('hidden');
        fileListEl.innerHTML = '';

        currentNode.children.forEach(item => {
            const li = document.createElement('li');
            li.className = `file-item ${item.type}`;
            li.dataset.id = item.id;
            li.dataset.type = item.type;
            
            const depthIndent = ' '.repeat(item.depth * 2);
            const depthIndicator = `<span class="depth-indicator"></span>`.repeat(item.depth);

            let actionsHtml = '';
            if (item.type === 'folder') {
                actionsHtml = `
                    <button class="rename-btn" data-id="${item.id}">é‡å‘½å</button>
                    <button class="delete-btn danger" data-id="${item.id}">åˆ é™¤</button>
                `;
            } else {
                actionsHtml = `
                    <button class="rename-btn" data-id="${item.id}">é‡å‘½å</button>
                    <button class="delete-btn danger" data-id="${item.id}">åˆ é™¤</button>
                `;
            }

            li.innerHTML = `
                <div class="name">
                    ${depthIndicator}
                    ${item.type === 'folder' ? 'ğŸ“' : 'ğŸ“„'} ${depthIndent}${item.name}
                </div>
                <div class="actions">
                    ${item.type === 'folder' ? `<button class="enter-btn" data-id="${item.id}">è¿›å…¥</button>` : ''}
                    ${actionsHtml}
                </div>
            `;
            fileListEl.appendChild(li);
        });
    }
}

fileListEl.addEventListener('click', function(e) {
    const target = e.target;
    const itemId = target.dataset.id;
    if (!itemId) return;

    const item = findNodeById(ROOT_NODE, itemId);
    if (!item) return;

    if (target.classList.contains('enter-btn')) {
        navigateToNode(item);
    } else if (target.classList.contains('rename-btn')) {
        if (item.type === 'folder') {
            const newName = prompt('è¯·è¾“å…¥æ–°çš„æ–‡ä»¶å¤¹åç§°:', item.name);
            if (newName && newName.trim() !== '') {
                item.name = newName.trim();
                updateFileList();
            }
        } else {
            const oldName = item.name;
            const extIndex = oldName.lastIndexOf('.');
            const nameWithoutExt = extIndex > -1 ? oldName.substring(0, extIndex) : oldName;
            const ext = extIndex > -1 ? oldName.substring(extIndex) : '';
            const newName = prompt('è¯·è¾“å…¥æ–°çš„æ–‡ä»¶åç§°:', nameWithoutExt);
            if (newName && newName.trim() !== '') {
                item.name = newName.trim() + ext;
                updateFileList();
            }
        }
    } else if (target.classList.contains('delete-btn')) {
        const confirmMsg = item.type === 'folder' 
            ? `ç¡®å®šè¦åˆ é™¤æ–‡ä»¶å¤¹ "${item.name}" åŠå…¶æ‰€æœ‰å†…å®¹å—ï¼Ÿ`
            : `ç¡®å®šè¦åˆ é™¤æ–‡ä»¶ "${item.name}" å—ï¼Ÿ`;
        
        if (confirm(confirmMsg)) {
            const parent = item.parent;
            parent.children = parent.children.filter(child => child.id !== itemId);
            updateFileList();
        }
    }
});

window.addEventListener('beforeunload', function(e) {
    if (hasFiles) {
        e.preventDefault();
        e.returnValue = 'ä½ æœ‰æœªå¯¼å‡ºçš„æ–‡ä»¶/æ–‡ä»¶å¤¹ï¼Œåˆ·æ–°/å…³é—­å°†ä¸¢å¤±æ‰€æœ‰æ•°æ®ï¼Œç¡®å®šç»§ç»­å—ï¼Ÿ';
        return e.returnValue;
    }
});

backBtn.addEventListener('click', function() {
    if (hasFiles && !confirm('ä½ æœ‰æœªå¯¼å‡ºçš„æ–‡ä»¶/æ–‡ä»¶å¤¹ï¼Œç¦»å¼€å°†ä¸¢å¤±æ‰€æœ‰æ•°æ®ï¼Œç¡®å®šè¿”å›å—ï¼Ÿ')) {
        return;
    }
    window.location.href = 'https://www.cmh.he.cn';
});

importBtn.addEventListener('click', function() {
    fileInput.click();
});

fileInput.addEventListener('change', function(e) {
    const selectedFiles = Array.from(e.target.files);
    if (selectedFiles.length === 0) return;

    const newFiles = selectedFiles.map(file => ({
        id: generateUniqueId(),
        name: file.name,
        type: 'file',
        file: file,
        parent: currentNode,
        depth: currentNode.depth
    }));
    
    currentNode.children = [...currentNode.children, ...newFiles];
    updateFileList();
    this.value = '';
});

newFolderBtn.addEventListener('click', function() {
    if (currentNode.depth >= 3) {
        alert('æœ€å¤šåªèƒ½åˆ›å»º3å±‚åµŒå¥—æ–‡ä»¶å¤¹ï¼');
        return;
    }

    const folderName = prompt('è¯·è¾“å…¥æ–‡ä»¶å¤¹åç§°:', 'æ–°å»ºæ–‡ä»¶å¤¹');
    if (folderName && folderName.trim() !== '') {
        const folderNode = {
            id: generateUniqueId(),
            name: folderName.trim(),
            type: 'folder',
            children: [],
            parent: currentNode,
            depth: currentNode.depth + 1
        };
        currentNode.children.push(folderNode);
        updateFileList();
    }
});

exportZipBtn.addEventListener('click', async function() {
    if (ROOT_NODE.children.length === 0) {
        alert('æš‚æ— æ–‡ä»¶å¯å‹ç¼©ï¼Œè¯·å…ˆå¯¼å…¥æ–‡ä»¶æˆ–æ–°å»ºæ–‡ä»¶å¤¹ï¼');
        return;
    }

    const zip = new JSZip();
    function buildZipStructure(zip, node, path = '') {
        const currentPath = path ? `${path}/${node.name}` : node.name;
        if (node.type === 'folder' && node.children.length > 0) {
            const folder = zip.folder(currentPath);
            node.children.forEach(child => {
                buildZipStructure(folder || zip, child, currentPath);
            });
        } else if (node.type === 'file') {
            zip.file(currentPath, node.file);
        }
    }

    ROOT_NODE.children.forEach(item => {
        buildZipStructure(zip, item);
    });

    try {
        const content = await zip.generateAsync({ 
            type: 'blob',
            compression: 'DEFLATE',
            compressionOptions: { level: 9 }
        });
        saveAs(content, 'å‹ç¼©æ–‡ä»¶.zip');
    } catch (error) {
        alert('å‹ç¼©å¤±è´¥: ' + error.message);
    }
});

updatePathBar();
updateFileList();
</script>
</body>
</html>