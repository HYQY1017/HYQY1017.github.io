<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>视频转换 - 小何转换</title>
    <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin">
    <meta http-equiv="Cross-Origin-Embedder-Policy" content="require-corp">
    <style>
        * {margin:0;padding:0;box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;}
        body {background:#fff;color:#000;padding:40px 20px;}
        .header {max-width:1000px;margin:0 auto 40px;display:flex;align-items:center;justify-content:space-between;}
        .back-btn {background:#000;color:#fff;border:none;border-radius:20px;padding:8px 16px;font-size:0.95rem;cursor:pointer;display:flex;align-items:center;gap:8px;}
        .page-title {font-size:2.2rem;font-weight:600;}
        .converter-container {max-width:1000px;margin:0 auto;background:#f9f9f9;border:1px solid #e6e6e6;border-radius:20px;padding:32px;}
        .upload-area {border:2px dashed #e6e6e6;border-radius:16px;padding:60px 20px;text-align:center;margin-bottom:32px;cursor:pointer;}
        .upload-text {font-size:1.1rem;margin-bottom:8px;}
        .upload-subtext {font-size:0.85rem;color:#6e6e73;}
        #file-input {display:none;}
        .settings-container {display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:32px;}
        .setting-group {display:flex;flex-direction:column;gap:8px;}
        .setting-label {font-size:0.95rem;font-weight:500;}
        .setting-select {padding:12px 16px;border:1px solid #e6e6e6;border-radius:12px;background:#fff;font-size:0.95rem;}
        .convert-btn {width:100%;background:#000;color:#fff;border:none;border-radius:12px;padding:16px;font-size:1.1rem;font-weight:500;cursor:pointer;}
        .convert-btn:disabled {background:#e6e6e6;color:#6e6e73;cursor:not-allowed;}
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.10/dist/ffmpeg.min.js"></script>
</head>
<body>
    <div class="header">
        <button class="back-btn" onclick="window.location.href='/'">← 返回主页</button>
        <h1 class="page-title">视频转换</h1>
    </div>

    <div class="converter-container">
        <div class="upload-area" onclick="document.getElementById('file-input').click()">
            <p class="upload-text">点击上传视频文件（推荐MP4格式）</p>
            <p class="upload-subtext">仅支持小文件测试（<50MB）</p>
            <input type="file" id="file-input" accept="video/mp4,video/mov" onchange="handleFileUpload(this)">
        </div>

        <div class="settings-container">
            <div class="setting-group">
                <label class="setting-label">输出格式</label>
                <select class="setting-select" id="format-select">
                    <option value="mp4">MP4</option>
                    <option value="mov">MOV</option>
                </select>
            </div>
        </div>
        
        <button class="convert-btn" id="convert-btn" disabled onclick="handleConvert()">开始转换</button>
    </div>

    <script>
        const { createFFmpeg, fetchFile } = FFmpeg;
        const ffmpeg = createFFmpeg({ log: false, corePath: 'https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.6/dist/ffmpeg-core.js' });
        let selectedFile = null;

        async function handleFileUpload(input) {
            if (input.files.length > 0) {
                selectedFile = input.files[0];
                document.getElementById('convert-btn').disabled = false;
                document.querySelector('.upload-text').textContent = `已选择: ${selectedFile.name}`;
            }
        }

        async function handleConvert() {
            if (!selectedFile) return;
            const btn = document.getElementById('convert-btn');
            btn.disabled = true;
            btn.textContent = "处理中...";

            try {
                await ffmpeg.load();
                const inputName = `input.${selectedFile.name.split('.').pop()}`;
                const outputName = `output.${document.getElementById('format-select').value}`;
                
                ffmpeg.FS('writeFile', inputName, await fetchFile(selectedFile));
                await ffmpeg.run('-i', inputName, '-c', 'copy', outputName);
                
                const data = ffmpeg.FS('readFile', outputName);
                const blob = new Blob([data.buffer], { type: `video/${document.getElementById('format-select').value}` });
                
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `converted_${Date.now()}.${document.getElementById('format-select').value}`;
                a.click();

                ffmpeg.FS('unlink', inputName);
                ffmpeg.FS('unlink', outputName);
                alert('转换完成！文件已下载。');
            } catch (e) {
                alert(`出错了：${e.message}\n请换小体积MP4文件重试`);
            } finally {
                btn.textContent = "开始转换";
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
